---
- name: Setup nginx for the application
  hosts: app
  become: true
  gather_facts: False
  vars_prompt:
    - name: run_roles
      prompt: "Install nginx from scratch?"
      default: "n"
    - name: install_letsencrypt
      prompt: "Install lestencrypt certificates?"
      default: "n"
  vars_files:
    - "vars/main.yml"
  vars:
    - ssl_key_path: "/etc/letsencrypt/live/{{app_domain}}"
    - ssl_key: "fullchain.pem"
    - ssl_cert_path: "/etc/letsencrypt/live/{{app_domain}}"
    - ssl_cert: "privkey.pem"
  roles:
    - { role: nginx, when: run_roles == "y" }
    - { role: letsencrypt, when: install_letsencrypt == "y" }
  tasks:
    - name: copy nginx virtual host file
      template: src="templates/{{env}}-nginx-config-with-ssl.j2"
                dest="/etc/nginx/sites-available/{{app_name}}"
                owner=root
                group=root

    - name: link nginx virtual host file
      file: src="/etc/nginx/sites-available/{{app_name}}"
            dest="/etc/nginx/sites-enabled/{{app_name}}"
            state=link

    - name: restart nginx
      service: name=nginx state=restarted

